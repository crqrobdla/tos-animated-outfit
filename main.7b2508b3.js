let spineData=[];let currentPlayer=null;let currentPosX=0;let currentPosY=0;async function loadOptions(){try{const response=await fetch('./spines.json');spineData=await response.json();}catch(error){console.error('Error loading options:',error);}}
function updateAnimationOptions(category,searchQuery=""){const select=document.getElementById("animation-select");select.innerHTML='<option value="">請選擇角色</option>';let filteredData=spineData.filter(item=>item.category===category);if(searchQuery){searchQuery=searchQuery.toLowerCase();filteredData=filteredData.filter(item=>item.name.toLowerCase().includes(searchQuery)||item.monsterid.toLowerCase().includes(searchQuery));}
filteredData.forEach(item=>{const option=document.createElement("option");option.value=JSON.stringify(item);option.text=item.name+" (ID: "+item.monsterid+")";select.add(option);});select.disabled=filteredData.length===0;}
loadOptions();document.getElementById("category-select").addEventListener("change",function(event){const selectedCategory=event.target.value;if(selectedCategory){updateAnimationOptions(selectedCategory);}else{document.getElementById("animation-select").innerHTML='<option value="">請選擇角色</option>';document.getElementById("animation-select").disabled=true;}});document.getElementById("search-input").addEventListener("input",function(event){const searchQuery=event.target.value;const selectedCategory=document.getElementById("category-select").value;if(selectedCategory){updateAnimationOptions(selectedCategory,searchQuery);}});function loadSpineAnimation(category,folder,spinename,scale=1,pma=true){const skelUrl=`./assets/${category}/${folder}/${spinename}.skel`;const atlasUrl=`./assets/${category}/${folder}/${spinename}.atlas`;document.getElementById('spine-container').innerHTML='';currentPlayer=new spine.SpinePlayer("spine-container",{skelUrl:skelUrl,atlasUrl:atlasUrl,backgroundColor:"#666666",alpha:true,premultipliedAlpha:pma,loop:true,fitToCanvas:true,showControls:true,viewport:{padLeft:"1%",padRight:"1%",padTop:"1%",padBottom:"1%"},success:(player)=>{const firstAnimation=player.skeleton.data.animations[0].name;player.setAnimation(firstAnimation,true);}});}
document.getElementById("animation-select").addEventListener("change",function(event){const selectedValue=event.target.value;if(selectedValue){const scaleSlider=document.getElementById("scale-slider");scaleSlider.value=1;currentPosX=0;currentPosY=0;const selectedData=JSON.parse(selectedValue);const scale=parseFloat(scaleSlider.value);const pma=selectedData.pma;if(currentPlayer){document.getElementById('spine-container').innerHTML='';currentPlayer=null;}
loadSpineAnimation(selectedData.category,selectedData.folder,selectedData.spinename,scale,pma);}else{document.getElementById('spine-container').innerHTML='';}});document.getElementById("scale-slider").addEventListener("input",function(event){const scale=parseFloat(event.target.value);if(currentPlayer&&currentPlayer.skeleton){currentPlayer.skeleton.scaleX=scale;currentPlayer.skeleton.scaleY=scale;}});function moveSpine(direction){const moveAmount=400;if(currentPlayer&&currentPlayer.skeleton){switch(direction){case"up":currentPosY+=moveAmount;break;case"down":currentPosY-=moveAmount;break;case"left":currentPosX-=moveAmount;break;case"right":currentPosX+=moveAmount;break;}
currentPlayer.skeleton.x=currentPosX;currentPlayer.skeleton.y=currentPosY;}}
document.addEventListener("keydown",function(event){switch(event.key){case"ArrowUp":moveSpine("up");break;case"ArrowDown":moveSpine("down");break;case"ArrowLeft":moveSpine("left");break;case"ArrowRight":moveSpine("right");break;default:return;}});const moveButtons={up:document.getElementById("up-btn"),down:document.getElementById("down-btn"),left:document.getElementById("left-btn"),right:document.getElementById("right-btn")};let moveInterval=null;const moveSpeed=50;function startMoving(direction){moveSpine(direction);moveInterval=setInterval(()=>moveSpine(direction),moveSpeed);}
function stopMoving(){if(moveInterval){clearInterval(moveInterval);moveInterval=null;}}
Object.keys(moveButtons).forEach(direction=>{const button=moveButtons[direction];button.addEventListener("mousedown",()=>startMoving(direction));button.addEventListener("mouseup",stopMoving);button.addEventListener("mouseleave",stopMoving);button.addEventListener("touchstart",(event)=>{event.preventDefault();startMoving(direction);});button.addEventListener("touchend",stopMoving);button.addEventListener("touchcancel",stopMoving);});["category-select","animation-select","scale-slider"].forEach(id=>{document.getElementById(id).addEventListener("keydown",function(event){if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(event.key)){event.preventDefault();}});});document.getElementById("reset-scale-btn").addEventListener("click",function(){const scaleSlider=document.getElementById("scale-slider");scaleSlider.value=1;if(currentPlayer&&currentPlayer.skeleton){currentPlayer.skeleton.scaleX=1;currentPlayer.skeleton.scaleY=1;}});const menuToggle=document.getElementById('menu-toggle');const sidebar=document.getElementById('sidebar');menuToggle.addEventListener('click',()=>{sidebar.classList.toggle('open');});